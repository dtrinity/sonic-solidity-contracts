#!/bin/sh
# Shared pre-commit hook for dTrinity Hardhat projects

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# Check if we're in a Hardhat project
if [ ! -f "hardhat.config.ts" ] && [ ! -f "hardhat.config.js" ]; then
  echo "${YELLOW}Warning: Not in a Hardhat project root${NC}"
  exit 0
fi

# Function to check if command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

# Run Solhint if available
if [ -f "contracts" ] && command_exists npx && [ -f "node_modules/.bin/solhint" ]; then
  echo "Running Solhint..."
  if [ -f ".shared/scripts/analysis/solhint.ts" ]; then
    npx ts-node .shared/scripts/analysis/solhint.ts
  else
    npx solhint 'contracts/**/*.sol'
  fi

  if [ $? -ne 0 ]; then
    echo "${RED}Solhint found issues. Please fix them before committing.${NC}"
    exit 1
  fi
fi

# Run prettier check if available
if command_exists npx && [ -f "node_modules/.bin/prettier" ]; then
  echo "Checking code formatting..."
  npx prettier --check 'contracts/**/*.sol' 'test/**/*.ts' 'scripts/**/*.ts' 2>/dev/null

  if [ $? -ne 0 ]; then
    echo "${YELLOW}Some files are not properly formatted. Run 'npm run format' to fix.${NC}"
    # Don't fail on prettier issues, just warn
  fi
fi

# Check for console.log in Solidity files
if grep -r "console\.log" contracts --include="*.sol" 2>/dev/null; then
  echo "${RED}Found console.log statements in Solidity files. Please remove them before committing.${NC}"
  exit 1
fi

# Check for .only in test files
if grep -r "\.only" test --include="*.ts" --include="*.js" 2>/dev/null; then
  echo "${YELLOW}Warning: Found .only in test files. Make sure this is intentional.${NC}"
fi

# Run compile to ensure contracts compile
if command_exists npx; then
  echo "Compiling contracts..."
  npx hardhat compile >/dev/null 2>&1

  if [ $? -ne 0 ]; then
    echo "${RED}Contract compilation failed. Please fix compilation errors before committing.${NC}"
    exit 1
  fi
fi

echo "${GREEN}Pre-commit checks passed!${NC}"
exit 0