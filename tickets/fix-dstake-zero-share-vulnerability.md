# Ticket: Fix zero-share mint vulnerability in `DStakeToken`

## Context / Problem

When `totalSupply() == 0` but `totalAssets() > 0` (a state that happens after the last withdrawal leaves fee **dust** inside the strategy), OpenZeppelin v5.x `ERC4626Upgradeable` math can return **0 shares** for deposits smaller than the residual value:

```
shares = assets * (totalSupply + 10**offset) / (totalAssets + 1)
```
(rounded down).

Because `deposit()` in `ERC4626Upgradeable` **does not check that `shares > 0`**, the transaction goes through, transfers the caller's `dStable` tokens to the vault, and mints **zero shares**, resulting in permanent loss of the deposit.

Issue originally reported in [GitHub issue #286](https://github.com/hats-finance/dTRINITY-0xee5c6f15e8d0b55a5eff84bb66beeee0e6140ffe/issues/286).

## Impact

* Any user who deposits an amount smaller than the residual dust will lose 100 % of what they send.
* The attack is cheap: simply be the last (large) withdrawer so that the dust equals the withdrawal fee on the entire TVL (≈ 1 % today).
* The vulnerability remains until a user finally deposits ≥ dust.

## Proposed Fix

Add an explicit guard that reverts when the computed share amount is zero. Two alternatives:

1. **Minimal gas:**
   ```solidity
   function _deposit(..., uint256 shares) internal override {
       require(shares > 0, "ZERO_SHARES");
       // existing logic …
   }
   ```
2. **Allow the very first deposit into an empty vault:**
   ```solidity
   if (totalSupply() > 0) {
       require(shares > 0, "ZERO_SHARES");
   }
   ```

Option 2 is friendlier if governance ever seeds the vault with a tiny dust amount intentionally.

## Tasks

- [ ] Implement guard in `contracts/vaults/dstake/DStakeToken.sol`.
- [ ] Add unit tests reproducing the zero-share scenario and asserting revert.
- [ ] Run `yarn hardhat test` & CI.
- [ ] Update documentation comment if behaviour changes.
- [ ] Consider setting a `dustTolerance` upper bound or alert if `totalAssets()` while `totalSupply()==0` exceeds that bound.

## Severity & Priority

Severity : **High** (complete loss of user funds for affected deposits).  
Priority : **P1** (patch in next release). 